<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Firmar Documento PDF</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 10px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    #toolbar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .toolbar-btn {
      background: #2980b9;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    #page-info {
      color: white;
      margin-top: 5px;
      font-weight: bold;
    }
    #file-input {
      margin-top: 10px;
    }

    #pdf-container {
      position: relative;
      margin: 0 auto;
      padding: 10px;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    canvas {
      border: 1px solid #ccc;
      z-index: 1;
      max-width: 100%;
      height: auto;
    }

    .signature-box {
      position: absolute;
      border: 2px dashed #3498db;
      background: rgba(255, 255, 255, 0.0);
      z-index: 5;
      display: flex;
      flex-direction: column;
      resize: both;
      overflow: hidden;
      touch-action: none;
    }

    .signature-controls {
      display: flex;
      justify-content: space-around;
      background: rgba(0, 0, 0, 0.3);
      cursor: move;
      user-select: none;
    }

    .signature-controls button {
      border: none;
      color: white;
      font-weight: bold;
      width: 30px;
      height: 30px;
      font-size: 16px;
      cursor: pointer;
    }

    .confirm-btn { background: #2ecc71; }
    .remove-btn  { background: #e74c3c; }
    .clear-btn   { background: #f39c12; display: none; }
  </style>
</head>
<body>
  <header>
    <h2>Firmar Documento PDF</h2>
    <div id="toolbar">
      <button class="toolbar-btn" onclick="prevPage()">‚¨ÖÔ∏è Anterior</button>
      <button class="toolbar-btn" onclick="nextPage()">‚û°Ô∏è Siguiente</button>
      <button class="toolbar-btn" onclick="addSignatureBox()">‚úçÔ∏è A√±adir Firma</button>
      <button class="toolbar-btn" onclick="downloadPDF()">üíæ Guardar</button>
    </div>
    <div id="page-info">P√°gina <span id="current-page">1</span> de <span id="total-pages">1</span></div>
    <input type="file" id="file-input" accept="application/pdf" />
  </header>

  <div id="pdf-container"></div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pdfDoc = null, currentPage = 1, totalPages = 0;
    let pdfCanvases = [];

    document.getElementById('file-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function () {
        try {
          const loadingTask = pdfjsLib.getDocument({ data: reader.result });
          pdfDoc = await loadingTask.promise;
          totalPages = pdfDoc.numPages;
          document.getElementById('total-pages').textContent = totalPages;
          pdfCanvases = [];
          renderPage(currentPage);
        } catch (err) {
          alert('Error al cargar PDF.');
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function renderPage(pageNum) {
      const container = document.getElementById('pdf-container');
      container.innerHTML = '';
      pdfDoc.getPage(pageNum).then(page => {
        const scale = 1.5;
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        canvas.dataset.pageNumber = pageNum;
        container.appendChild(canvas);
        page.render({ canvasContext: context, viewport }).promise.then(() => {
          pdfCanvases[pageNum - 1] = canvas;
          document.getElementById('current-page').textContent = pageNum;
        });
      });
    }

    function prevPage() {
      if (currentPage <= 1) return;
      currentPage--;
      renderPage(currentPage);
    }

    function nextPage() {
      if (currentPage >= totalPages) return;
      currentPage++;
      renderPage(currentPage);
    }

    function addSignatureBox() {
      const canvas = document.querySelector('#pdf-container canvas');
      if (!canvas) return alert('Primero carga un PDF');
      const box = document.createElement('div');
      box.className = 'signature-box';
      box.style.left = '100px';
      box.style.top = '100px';
      box.style.width = '200px';
      box.style.height = '100px';

      const controls = document.createElement('div');
      controls.className = 'signature-controls';

      const confirmBtn = document.createElement('button');
      confirmBtn.className = 'confirm-btn';
      confirmBtn.textContent = '‚úì';

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = '‚úï';

      const clearBtn = document.createElement('button');
      clearBtn.className = 'clear-btn';
      clearBtn.textContent = '‚Ü©Ô∏è';

      controls.appendChild(confirmBtn);
      controls.appendChild(clearBtn);
      controls.appendChild(removeBtn);
      box.appendChild(controls);

      const pad = document.createElement('canvas');
      pad.style.flex = '1';
      pad.style.width = '100%';
      pad.style.height = '100%';
      pad.width = 200;
      pad.height = 70;
      pad.style.pointerEvents = 'none';
      box.appendChild(pad);

      makeDraggable(box, controls);
      makeResizable(box, pad);
      document.getElementById('pdf-container').appendChild(box);

      let drawEnabled = false;

      confirmBtn.onclick = () => {
        if (!drawEnabled) {
          pad.style.pointerEvents = 'auto';
          drawEnabled = true;
          clearBtn.style.display = 'inline-block';
        } else {
          const ctx = canvas.getContext('2d');
          const padRect = pad.getBoundingClientRect();
          const canvasRect = canvas.getBoundingClientRect();
          const x = padRect.left - canvasRect.left;
          const y = padRect.top - canvasRect.top;
          ctx.drawImage(pad, x, y, pad.width, pad.height);
          box.remove();
        }
      };

      clearBtn.onclick = () => {
        const ctx = pad.getContext('2d');
        ctx.clearRect(0, 0, pad.width, pad.height);
      };

      removeBtn.onclick = () => box.remove();
    }

    function enableDrawing(canvas) {
      const ctx = canvas.getContext('2d');
      let drawing = false;

      function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
          x: clientX - rect.left,
          y: clientY - rect.top
        };
      }

      function start(e) {
        drawing = true;
        const pos = getPosition(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        e.preventDefault();
      }

      function draw(e) {
        if (!drawing) return;
        const pos = getPosition(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        e.preventDefault();
      }

      function end() {
        drawing = false;
      }

      canvas.addEventListener('mousedown', start);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', end);
      canvas.addEventListener('mouseleave', end);

      canvas.addEventListener('touchstart', start);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', end);
    }

    function makeDraggable(el, handle) {
      let offsetX = 0, offsetY = 0, isDragging = false;

      function startDrag(e) {
        isDragging = true;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        offsetX = clientX - el.offsetLeft;
        offsetY = clientY - el.offsetTop;
        e.preventDefault();
      }

      function onDrag(e) {
        if (!isDragging) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        el.style.left = (clientX - offsetX) + 'px';
        el.style.top = (clientY - offsetY) + 'px';
        e.preventDefault();
      }

      function stopDrag() {
        isDragging = false;
      }

      handle.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', stopDrag);

      handle.addEventListener('touchstart', startDrag);
      document.addEventListener('touchmove', onDrag);
      document.addEventListener('touchend', stopDrag);
    }

    function makeResizable(el, canvas) {
      const observer = new ResizeObserver(() => {
        canvas.width = el.offsetWidth;
        canvas.height = el.offsetHeight - 30;
        enableDrawing(canvas);
      });
      observer.observe(el);
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      for (let i = 0; i < pdfCanvases.length; i++) {
        if (i !== 0) doc.addPage();
        const canvas = pdfCanvases[i];
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const width = doc.internal.pageSize.getWidth();
        const height = doc.internal.pageSize.getHeight();
        doc.addImage(imgData, 'JPEG', 0, 0, width, height);
      }
      doc.save("documento_firmado.pdf");
    }
  </script>
</body>
</html>
