<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Firmar Documento PDF</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    #toolbar {
      margin: 1rem 0;
    }
    .toolbar-btn {
      background: #3498db;
      border: none;
      padding: 0.5rem 1rem;
      margin: 0.3rem;
      color: white;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    #pdf-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      position: relative;
    }
    .signature-box {
      position: absolute;
      border: 2px dashed #34495e;
      background: transparent;
      z-index: 1000;
      resize: both;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .signature-controls {
      display: flex;
      justify-content: space-between;
      background: #ecf0f1;
      padding: 4px;
      cursor: move;
    }
    .signature-controls button {
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      margin: 0 2px;
      border-radius: 4px;
      padding: 4px 8px;
    }
    .confirm-btn { background: #2ecc71; }
    .remove-btn  { background: #e74c3c; }
    .clear-btn   { background: #f39c12; display: none; }
  </style>
</head>
<body>
  <header>
    <h2>Firmar Documento PDF</h2>
    <div id="toolbar">
      <button class="toolbar-btn" onclick="prevPage()">‚¨ÖÔ∏è Anterior</button>
      <button class="toolbar-btn" onclick="nextPage()">‚û°Ô∏è Siguiente</button>
      <button class="toolbar-btn" onclick="addSignatureBox()">‚úçÔ∏è A√±adir Firma</button>
      <button class="toolbar-btn" onclick="downloadPDF()">üíæ Guardar</button>
      <button class="toolbar-btn" onclick="sharePDF()">üì§ Compartir</button>
    </div>
    <div id="page-info">P√°gina <span id="current-page">1</span> de <span id="total-pages">1</span></div>
    <input type="file" id="file-input" accept="application/pdf" />
  </header>

  <div id="pdf-container"></div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    let pdfDoc = null, currentPage = 1, totalPages = 0;
    let pdfCanvases = [], originalFileBuffer = null;

    document.getElementById('file-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function () {
        originalFileBuffer = reader.result;
        try {
          const loadingTask = pdfjsLib.getDocument({ data: reader.result });
          pdfDoc = await loadingTask.promise;
          totalPages = pdfDoc.numPages;
          document.getElementById('total-pages').textContent = totalPages;
          pdfCanvases = [];
          renderPage(currentPage);
        } catch (err) {
          alert('Error al cargar PDF.');
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function renderPage(pageNum) {
      const container = document.getElementById('pdf-container');
      container.innerHTML = '';
      pdfDoc.getPage(pageNum).then(page => {
        const scale = 1.5;
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        canvas.dataset.pageNumber = pageNum;
        container.appendChild(canvas);
        page.render({ canvasContext: context, viewport }).promise.then(() => {
          pdfCanvases[pageNum - 1] = canvas;
          document.getElementById('current-page').textContent = pageNum;
        });
      });
    }

    function prevPage() {
      if (currentPage <= 1) return;
      currentPage--;
      renderPage(currentPage);
    }

    function nextPage() {
      if (currentPage >= totalPages) return;
      currentPage++;
      renderPage(currentPage);
    }

    function addSignatureBox() {
      const canvas = document.querySelector('#pdf-container canvas');
      if (!canvas) return alert('Primero carga un PDF');
      const box = document.createElement('div');
      box.className = 'signature-box';
      box.style.left = '100px';
      box.style.top = '100px';
      box.style.width = '200px';
      box.style.height = '100px';

      const controls = document.createElement('div');
      controls.className = 'signature-controls';

      const confirmBtn = document.createElement('button');
      confirmBtn.className = 'confirm-btn';
      confirmBtn.textContent = '‚úì';

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = '‚úï';

      const clearBtn = document.createElement('button');
      clearBtn.className = 'clear-btn';
      clearBtn.textContent = '‚Ü©Ô∏è';

      controls.appendChild(confirmBtn);
      controls.appendChild(clearBtn);
      controls.appendChild(removeBtn);
      box.appendChild(controls);

      const pad = document.createElement('canvas');
      pad.style.flex = '1';
      pad.style.width = '100%';
      pad.style.height = '100%';
      pad.width = 200;
      pad.height = 70;
      pad.style.pointerEvents = 'none';
      box.appendChild(pad);

      makeDraggable(box, controls);
      makeResizable(box, pad);
      document.getElementById('pdf-container').appendChild(box);

      let drawEnabled = false;

      confirmBtn.onclick = () => {
        if (!drawEnabled) {
          pad.style.pointerEvents = 'auto';
          drawEnabled = true;
          clearBtn.style.display = 'inline-block';
          enableDrawing(pad);
        } else {
          const ctx = canvas.getContext('2d');
          const padRect = pad.getBoundingClientRect();
          const canvasRect = canvas.getBoundingClientRect();
          const x = padRect.left - canvasRect.left;
          const y = padRect.top - canvasRect.top;
          ctx.drawImage(pad, x, y, pad.width, pad.height);
          box.remove();
        }
      };

      clearBtn.onclick = () => {
        const ctx = pad.getContext('2d');
        ctx.clearRect(0, 0, pad.width, pad.height);
      };

      removeBtn.onclick = () => box.remove();
    }

    function enableDrawing(canvas) {
      const ctx = canvas.getContext('2d');
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = 'black';
      let drawing = false;

      function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
          x: clientX - rect.left,
          y: clientY - rect.top
        };
      }

      canvas.onmousedown = (e) => {
        drawing = true;
        const pos = getPosition(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        e.preventDefault();
      };
      canvas.onmousemove = (e) => {
        if (!drawing) return;
        const pos = getPosition(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        e.preventDefault();
      };
      canvas.onmouseup = () => drawing = false;
      canvas.onmouseleave = () => drawing = false;

      canvas.ontouchstart = canvas.onmousedown;
      canvas.ontouchmove = canvas.onmousemove;
      canvas.ontouchend = () => drawing = false;
    }

    function makeDraggable(el, handle) {
      let offsetX = 0, offsetY = 0, isDragging = false;

      function startDrag(e) {
        isDragging = true;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        offsetX = clientX - el.offsetLeft;
        offsetY = clientY - el.offsetTop;
        e.preventDefault();
      }

      function onDrag(e) {
        if (!isDragging) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        el.style.left = (clientX - offsetX) + 'px';
        el.style.top = (clientY - offsetY) + 'px';
        e.preventDefault();
      }

      function stopDrag() {
        isDragging = false;
      }

      handle.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', stopDrag);

      handle.addEventListener('touchstart', startDrag);
      document.addEventListener('touchmove', onDrag);
      document.addEventListener('touchend', stopDrag);
    }

    function makeResizable(el, canvas) {
      const observer = new ResizeObserver(() => {
        canvas.width = el.offsetWidth;
        canvas.height = el.offsetHeight - 30;
      });
      observer.observe(el);
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      for (let i = 0; i < pdfCanvases.length; i++) {
        const canvas = pdfCanvases[i];
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const width = pdf.internal.pageSize.getWidth();
        const height = (canvas.height * width) / canvas.width;

        if (i > 0) pdf.addPage();
        pdf.addImage(imgData, 'JPEG', 0, 0, width, height);
      }

      pdf.save('documento_firmado.pdf');
    }

    function sharePDF() {
      alert('Funcionalidad de compartir pr√≥ximamente.');
    }
  </script>
</body>
</html>
