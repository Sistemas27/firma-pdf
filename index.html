<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>Firmar Documento PDF</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    #toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 1rem 0;
    }
    .toolbar-btn {
      background: #3498db;
      border: none;
      padding: 0.5rem 1rem;
      margin: 0.3rem;
      color: white;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    #pdf-container {
      width: 100vw;
      height: 100vh;
      overflow: auto;
      position: relative;
      touch-action: manipulation;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff;
    }
    canvas {
      max-width: 100%;
      height: auto;
      display: block;
    }
    .signature-box {
      position: absolute;
      border: 2px dashed #34495e;
      background: transparent;
      z-index: 1000;
      resize: both;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      touch-action: none;
    }
    .signature-controls {
      display: flex;
      justify-content: space-between;
      background: #ecf0f1;
      padding: 4px;
      cursor: move;
    }
    .signature-controls button {
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      margin: 0 2px;
      border-radius: 4px;
      padding: 4px 8px;
    }
    .confirm-btn { background: #2ecc71; }
    .remove-btn  { background: #e74c3c; }
    .clear-btn   { background: #f39c12; display: none; }
  </style>
</head>
<body>
  <header>
    <h2>Firmar Documento PDF</h2>
    <div id="toolbar">
      <button class="toolbar-btn" onclick="prevPage()">‚¨ÖÔ∏è Anterior</button>
      <button class="toolbar-btn" onclick="nextPage()">‚û°Ô∏è Siguiente</button>
      <button class="toolbar-btn" onclick="addSignatureBox()">‚úçÔ∏è A√±adir Firma</button>
      <button class="toolbar-btn" onclick="downloadPDF()">üìÇ Guardar</button>
      <button class="toolbar-btn" onclick="sharePDF()">üì§ Compartir</button>
    </div>
    <div id="page-info">P√°gina <span id="current-page">1</span> de <span id="total-pages">1</span></div>
    <input type="file" id="file-input" accept="application/pdf" />
  </header>
  <div id="pdf-container"></div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    let pdfDoc = null, currentPage = 1, totalPages = 0;
    let pdfCanvases = [], originalFileBuffer = null;

    document.getElementById('file-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function () {
        originalFileBuffer = reader.result;
        try {
          const loadingTask = pdfjsLib.getDocument({ data: reader.result });
          pdfDoc = await loadingTask.promise;
          totalPages = pdfDoc.numPages;
          document.getElementById('total-pages').textContent = totalPages;
          pdfCanvases = [];
          renderPage(currentPage);
        } catch (err) {
          alert('Error al cargar PDF.');
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function renderPage(pageNum) {
      const container = document.getElementById('pdf-container');
      container.innerHTML = '';
      pdfDoc.getPage(pageNum).then(page => {
        const scale = 2.5;
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        canvas.dataset.pageNumber = pageNum;
        container.appendChild(canvas);
        page.render({ canvasContext: context, viewport }).promise.then(() => {
          pdfCanvases[pageNum - 1] = canvas;
          document.getElementById('current-page').textContent = pageNum;
        });
      });
    }

    function prevPage() {
      if (currentPage <= 1) return;
      currentPage--;
      renderPage(currentPage);
    }

    function nextPage() {
      if (currentPage >= totalPages) return;
      currentPage++;
      renderPage(currentPage);
    }

    function addSignatureBox() {
      const canvas = document.querySelector('#pdf-container canvas');
      if (!canvas) return alert('Primero carga un PDF');
      const container = document.getElementById('pdf-container');
      const box = document.createElement('div');
      box.className = 'signature-box';
      box.style.left = '50px';
      box.style.top = '50px';
      box.style.width = '200px';
      box.style.height = '100px';

      const controls = document.createElement('div');
      controls.className = 'signature-controls';

      const confirmBtn = document.createElement('button');
      confirmBtn.className = 'confirm-btn';
      confirmBtn.textContent = '‚úì';

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = '‚úï';

      const clearBtn = document.createElement('button');
      clearBtn.className = 'clear-btn';
      clearBtn.textContent = '‚Ü©Ô∏è';

      controls.appendChild(confirmBtn);
      controls.appendChild(clearBtn);
      controls.appendChild(removeBtn);
      box.appendChild(controls);

      const pad = document.createElement('canvas');
      pad.style.flex = '1';
      pad.width = 200;
      pad.height = 70;
      pad.style.width = '100%';
      pad.style.height = '100%';
      pad.style.pointerEvents = 'none';
      box.appendChild(pad);

      let drawEnabled = false;
      confirmBtn.onclick = () => {
        if (!drawEnabled) {
          pad.style.pointerEvents = 'auto';
          clearBtn.style.display = 'inline-block';
          drawEnabled = true;
          enableDrawing(pad);
        } else {
          const ctx = canvas.getContext('2d');
          const padRect = pad.getBoundingClientRect();
          const canvasRect = canvas.getBoundingClientRect();
          const x = padRect.left - canvasRect.left;
          const y = padRect.top - canvasRect.top;
          ctx.drawImage(pad, x, y, pad.width, pad.height);
          box.remove();
        }
      };

      clearBtn.onclick = () => pad.getContext('2d').clearRect(0, 0, pad.width, pad.height);
      removeBtn.onclick = () => box.remove();

      makeDraggable(box, controls, canvas);
      container.appendChild(box);
    }

    function enableDrawing(canvas) {
      const ctx = canvas.getContext('2d');
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = 'black';
      let drawing = false;

      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        return { x, y };
      }

      canvas.onpointerdown = e => {
        drawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        e.preventDefault();
      };
      canvas.onpointermove = e => {
        if (!drawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        e.preventDefault();
      };
      canvas.onpointerup = () => drawing = false;
      canvas.onpointerleave = () => drawing = false;
    }

    function makeDraggable(box, handle, boundaryCanvas) {
      let offsetX = 0, offsetY = 0, dragging = false;

      function getTouchEvent(e) {
        return e.touches ? e.touches[0] : e;
      }

      handle.addEventListener('pointerdown', e => {
        const ev = getTouchEvent(e);
        dragging = true;
        offsetX = ev.clientX - box.offsetLeft;
        offsetY = ev.clientY - box.offsetTop;
        e.preventDefault();
      });

      document.addEventListener('pointermove', e => {
        if (!dragging) return;
        const ev = getTouchEvent(e);
        const canvasRect = boundaryCanvas.getBoundingClientRect();
        let left = ev.clientX - offsetX;
        let top = ev.clientY - offsetY;

        left = Math.max(canvasRect.left, Math.min(left, canvasRect.right - box.offsetWidth));
        top = Math.max(canvasRect.top, Math.min(top, canvasRect.bottom - box.offsetHeight));

        box.style.left = (left - canvasRect.left) + 'px';
        box.style.top = (top - canvasRect.top) + 'px';
        e.preventDefault();
      });

      document.addEventListener('pointerup', () => dragging = false);
    }

    function downloadPDF() {
      alert('Funcionalidad de guardado pendiente de implementar.');
    }

    function sharePDF() {
      alert('Funcionalidad de compartir pendiente de implementar.');
    }
  </script>
</body>
</html>
